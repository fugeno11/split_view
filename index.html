<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Redbay Technologies</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="redbay.png" href="https://www.redbayuav.com/wp-content/uploads/2017/08/redbaylogo-300x212.png">

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />

  <style>
    html, body { width:100%; height:100%; margin:0; padding:0; overflow:hidden; background:#000; }

    #mainContainer {
      width: 100%;
      height: 100%;
      display: flex;
      position: relative;
    }

    #cesiumContainer {
      width: 100%;
      height: 100%;
      transition: width 0.3s ease;
      position: relative;
    }

    #cesiumContainer.split {
      width: 50%;
    }

    #secondViewContainer {
      width: 0;
      height: 100%;
      border-left: 2px solid #333;
      overflow: hidden;
      transition: width 0.3s ease;
      position: relative;
      background: #000;
    }

    #secondViewContainer.active {
      width: 50%;
    }

    #secondViewFrame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 10;
      background: rgba(0,0,0,0.92);
      color: #ffffff;
      padding: 12px;
      border-radius: 12px;
      width: 260px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 12px 28px rgba(0,0,0,0.65);
      transition: transform 0.3s ease;
    }

    .panel.collapsed {
      transform: translateX(-280px);
    }

    .panel-toggle {
      position: absolute;
      right: -40px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 60px;
      background: rgba(0,0,0,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      border-left: none;
      border-radius: 0 12px 12px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #fff;
      font-size: 20px;
      transition: background 0.2s ease;
    }

    .panel-toggle:hover {
      background: rgba(20,20,20,0.95);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .brand img {
      display: block;
      transition: opacity 0.2s ease;
    }

    .brand a:hover img {
      opacity: 0.8;
    }

    .badge {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #000;
      border: 1px solid rgba(255,255,255,0.15);
      opacity: 0.95;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-block;
      margin-bottom: 8px;
      text-decoration: none;
      color: #fff;
    }

    .badge:hover {
      border-color: rgba(255,255,255,0.35);
      opacity: 1;
      background: #111;
    }

    .row { margin: 6px 0; display: flex; gap: 6px; align-items: center; }

    select, button {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      background: #000;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      outline: none;
    }

    button { cursor: pointer; }
    button:hover { border-color: rgba(255,255,255,0.35); background: #111; }

    #btnSplitScreen {
      background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
      border: 1px solid rgba(255,255,255,0.2);
    }

    #btnSplitScreen.active {
      background: linear-gradient(135deg, #2a4a2a 0%, #1a3a1a 100%);
      border-color: rgba(100,255,100,0.4);
    }

    .footer {
      margin-top: 8px;
      font-size: 11px;
      opacity: 0.72;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 8px;
    }

    .cesium-viewer-bottom { bottom: 6px; }
  </style>
</head>

<body>
  <div id="mainContainer">
    <div id="cesiumContainer"></div>
    <div id="secondViewContainer">
      <iframe id="secondViewFrame" src=""></iframe>
    </div>
  </div>

  <div class="panel" id="controlPanel">
    <div class="panel-toggle" id="panelToggle">›</div>

    <div class="brand">
      <a href="https://www.redbayuav.com" target="_blank" style="text-decoration:none;">
        <img src="https://www.redbayuav.com/wp-content/uploads/2017/08/redbaylogo-300x212.png" alt="Redbay Technologies" style="height:30px; width:auto;">
      </a>
    </div>

    <a href="https://www.redbayuav.com" target="_blank" class="badge">Redbay Technologies</a>

    <div class="row">
      <select id="typeSelect">
        <option value="">Select</option>
        <option value="Nov-2025">Nov-2025</option>
        <option value="Jan-2026">Jan-2026</option>
      </select>
    </div>

    <div class="row" id="modelRow" style="display:none;">
      <select id="modelSelect"></select>
    </div>

    <div class="row">
      <button id="btnClearModels">Clear All Models</button>
    </div>

    <div class="row">
      <button id="btnZoom">Zoom to Model</button>
    </div>

    <div class="row">
      <button id="btnSplitScreen">Split Screen View</button>
    </div>

    <div class="row">
      <button id="btnMeasureDistance">Measure Distance</button>
    </div>
    <div class="row">
      <button id="btnMeasureArea">Measure Area</button>
    </div>
    <div class="row">
      <button id="btnMeasureHeight">Measure Height</button>
    </div>
    <div class="row">
      <button id="btnClearMeasures">Clear Measurements</button>
    </div>

    <div class="footer">
      <div><b>Redbay Technologies</b></div>
      <div id="statusText">Ready</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.127.0/Cesium.js"></script>
  <script>
    const PROJECT_LOCATION = { lon: 80.496093, lat: 16.542750, height: 350 };
    const HEIGHT_OFFSET_METERS = 60;

    Cesium.Ion.defaultAccessToken = undefined;

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: undefined,
      timeline: false,
      animation: false,
      geocoder: false,
      homeButton: true,
      sceneModePicker: true,
      baseLayerPicker: false,
      navigationHelpButton: false
    });

    viewer.imageryLayers.removeAll();
    viewer.imageryLayers.addImageryProvider(new Cesium.OpenStreetMapImageryProvider({
      url: "https://a.tile.openstreetmap.org/"
    }));

    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(PROJECT_LOCATION.lon, PROJECT_LOCATION.lat, PROJECT_LOCATION.height),
      orientation: { heading: Cesium.Math.toRadians(0), pitch: Cesium.Math.toRadians(-35), roll: 0 }
    });

    viewer.homeButton.viewModel.command.beforeExecute.addEventListener((e) => {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(PROJECT_LOCATION.lon, PROJECT_LOCATION.lat, PROJECT_LOCATION.height),
        orientation: { heading: Cesium.Math.toRadians(0), pitch: Cesium.Math.toRadians(-35), roll: 0 },
        duration: 1.2
      });
    });

    viewer.scene.globe.depthTestAgainstTerrain = false;

    // Panel toggle
    const controlPanel = document.getElementById("controlPanel");
    const panelToggle = document.getElementById("panelToggle");
    let isPanelCollapsed = false;

    panelToggle.addEventListener("click", () => {
      isPanelCollapsed = !isPanelCollapsed;
      if (isPanelCollapsed) {
        controlPanel.classList.add("collapsed");
        panelToggle.textContent = "‹";
      } else {
        controlPanel.classList.remove("collapsed");
        panelToggle.textContent = "›";
      }
    });

    const statusText = document.getElementById("statusText");
    function setStatus(t) { statusText.textContent = t; }

    let currentTilesets = [];

    async function loadTileset(url, clearFirst = false) {
      if (!url || !url.endsWith(".json")) return;
      if (clearFirst) {
        for (const ts of currentTilesets) viewer.scene.primitives.remove(ts);
        currentTilesets = [];
      }
      setStatus("Loading…");
      try {
        const tileset = await Cesium.Cesium3DTileset.fromUrl(url, { maximumScreenSpaceError: 2, maximumMemoryUsage: 4096 });
        const addedTileset = viewer.scene.primitives.add(tileset);
        currentTilesets.push(addedTileset);
        await tileset.readyPromise;

        const bs = tileset.boundingSphere;
        const carto = Cesium.Cartographic.fromCartesian(bs.center);
        const surface = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, carto.height);
        const offset = Cesium.Cartesian3.fromRadians(carto.longitude, carto.latitude, carto.height + HEIGHT_OFFSET_METERS);
        const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
        tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

        const allSpheres = currentTilesets.map(ts => ({ center: ts.boundingSphere.center, radius: ts.boundingSphere.radius }));
        if (allSpheres.length > 0) {
          const combinedSphere = Cesium.BoundingSphere.fromBoundingSpheres(allSpheres);
          viewer.scene.requestRender();
          viewer.camera.flyToBoundingSphere(combinedSphere, {
            duration: 1.2,
            offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-35), combinedSphere.radius * 2.5)
          });
        }
        setStatus(`Loaded (${currentTilesets.length} model${currentTilesets.length > 1 ? 's' : ''})`);
      } catch (err) {
        console.error(err);
        setStatus("Load failed");
        alert("Failed to load tileset:\n" + url);
      }
    }

    const BASE_URL = "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/amaravati-3d-data-files";
    const MODEL_OPTIONS = {
      "Nov-2025": [
        { label: "Go 1 and 2 Housing (Tower A)", url: BASE_URL + "/tower_A/tileset.json" },
        { label: "Non Gazetted Officers Housing (Tower B)", url: BASE_URL + "/tower_B/Non+Gazetted+Officers+Housing/tileset.json" },
        { label: "Project Office_PEB4_MLA_MLC_MP_AIS-Housing_Princ-Sec (Tower C)", url: BASE_URL + "/tower_C/Project+Office_PEB4_MLA_MLC_MP_AIS-Housing_Princ-Sec/tileset.json" }
      ],
      "Jan-2026": [
        { label: "4 PEB Structures near Project Office", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/amaravati-3d-data-files/4_PEB_Structures_near_project_office-Jan26/tileset.json" },
        { label: "Assembly", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Assembly-Jan26/tileset.json" },
        { label: "Bungalow for Principal Secretaries", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Bunglow_for_Principal_Secretaries-Jan26/tileset.json" },
        { label: "Bungalows for Hon'ble Ministers", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Bunglows_for_Hon'ble_Ministers-Jan26/tileset.json" },
        { label: "GAD Towers", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/GAD_Towers-Jan26/tileset.json" },
        { label: "GO I & II Housing", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/GO_I%26II_housing-Jan26/tileset.json" },
        { label: "Group D Housing", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Group_D_Housing-Jan26/tileset.json" },
        { label: "Happy Nest", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Happy_Nest-Jan26/tileset.json" },
        { label: "High Court", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/High_Court-Jan26/tileset.json" },
        { label: "Hon'ble AIS Officers Housing", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Hon'ble+_AIS_Officers_Housing-Jan26/tileset.json" },
        { label: "Hon'ble MLAs & MLCs Housing", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Hon'ble_MLAs%26MLCs_Housing-Jan26/tileset.json" },
        { label: "Non Gazetted Officers Housing", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Non_Gazetted_Officers_Housing-Jan26/tileset.json" },
        { label: "Project Office", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Project_Office-Jan26/tileset.json" },
        { label: "Parade Ground", url: "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/3D_Jan2026/Perade_Ground-Jan26/tileset.json" }
      ]
    };

    const typeSelect = document.getElementById("typeSelect");
    const modelSelect = document.getElementById("modelSelect");
    const modelRow = document.getElementById("modelRow");

    function updateModelOptions() {
      const type = typeSelect.value;
      modelSelect.innerHTML = "";
      modelRow.style.display = type ? "flex" : "none";
      if (!type) return;
      const options = MODEL_OPTIONS[type];
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select model";
      modelSelect.appendChild(placeholder);
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt.url;
        o.textContent = opt.label;
        modelSelect.appendChild(o);
      });
    }

    typeSelect.addEventListener("change", updateModelOptions);
    modelSelect.addEventListener("change", (e) => { if (e.target.value) loadTileset(e.target.value); });

    document.getElementById("btnZoom").addEventListener("click", async () => {
      if (currentTilesets.length === 0) return alert("Load at least one model first.");
      setStatus("Zooming…");
      const allSpheres = currentTilesets.map(ts => ({ center: ts.boundingSphere.center, radius: ts.boundingSphere.radius }));
      if (allSpheres.length > 0) {
        const combinedSphere = Cesium.BoundingSphere.fromBoundingSpheres(allSpheres);
        await viewer.camera.flyToBoundingSphere(combinedSphere, {
          duration: 1.2,
          offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-35), combinedSphere.radius * 2.5)
        });
      }
      setStatus(`Loaded (${currentTilesets.length} model${currentTilesets.length > 1 ? 's' : ''})`);
    });

    let isSplitScreenActive = false;
    const btnSplitScreen = document.getElementById("btnSplitScreen");
    const cesiumContainer = document.getElementById("cesiumContainer");
    const secondViewContainer = document.getElementById("secondViewContainer");
    const secondViewFrame = document.getElementById("secondViewFrame");

    btnSplitScreen.addEventListener("click", () => {
      isSplitScreenActive = !isSplitScreenActive;
      if (isSplitScreenActive) {
        cesiumContainer.classList.add("split");
        secondViewContainer.classList.add("active");
        btnSplitScreen.classList.add("active");
        btnSplitScreen.textContent = "Close Split View";
        setTimeout(() => { secondViewFrame.src = "https://amaravati-3d-data.s3.ap-southeast-2.amazonaws.com/coview/split-viewer.html"; }, 100);
        setStatus("Split screen active");
      } else {
        cesiumContainer.classList.remove("split");
        secondViewContainer.classList.remove("active");
        btnSplitScreen.classList.remove("active");
        btnSplitScreen.textContent = "Split Screen View";
        secondViewFrame.src = "";
        setStatus("Ready");
      }
    });

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    let mode = null, activePositions = [], activeEntity = null, labelEntity = null;
    const measureEntities = [];

    function pickPositionFromScreen(screenPos) {
      const scene = viewer.scene;
      const picked = scene.pickPosition(screenPos);
      if (Cesium.defined(picked)) return picked;
      const ray = viewer.camera.getPickRay(screenPos);
      return scene.globe.pick(ray, scene);
    }

    function carto(p) { return Cesium.Cartographic.fromCartesian(p); }

    function formatMeters(m) {
      if (!isFinite(m)) return "0 m";
      if (m >= 1000) return (m / 1000).toFixed(3) + " km";
      return m.toFixed(2) + " m";
    }

    function surfaceDistanceMeters(positions) {
      if (positions.length < 2) return 0;
      let total = 0;
      for (let i = 1; i < positions.length; i++) {
        const c1 = carto(positions[i - 1]), c2 = carto(positions[i]);
        const g = new Cesium.EllipsoidGeodesic(c1, c2);
        total += g.surfaceDistance;
      }
      return total;
    }

    function toENU2D(positions) {
      const origin = positions[0];
      const frame = Cesium.Transforms.eastNorthUpToFixedFrame(origin);
      const inv = Cesium.Matrix4.inverse(frame, new Cesium.Matrix4());
      return positions.map((p) => {
        const local = Cesium.Matrix4.multiplyByPoint(inv, p, new Cesium.Cartesian3());
        return { x: local.x, y: local.y };
      });
    }

    function polygonAreaSqMeters(positions) {
      if (positions.length < 3) return 0;
      const pts = toENU2D(positions);
      let sum = 0;
      for (let i = 0; i < pts.length; i++) {
        const j = (i + 1) % pts.length;
        sum += pts[i].x * pts[j].y - pts[j].x * pts[i].y;
      }
      return Math.abs(sum) / 2;
    }

    function formatArea(m2) {
      if (!isFinite(m2)) return "0 m²";
      if (m2 >= 1_000_000) return (m2 / 1_000_000).toFixed(4) + " km²";
      return m2.toFixed(2) + " m²";
    }

    function createOrUpdateLabel(text, position) {
      if (!labelEntity) {
        labelEntity = viewer.entities.add({
          position,
          label: {
            text, font: "14px sans-serif", showBackground: true,
            backgroundPadding: new Cesium.Cartesian2(8, 6),
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            pixelOffset: new Cesium.Cartesian2(0, -12)
          }
        });
        measureEntities.push(labelEntity);
      } else {
        labelEntity.position = position;
        labelEntity.label.text = text;
      }
    }

    function clearActive() {
      if (activeEntity) { viewer.entities.remove(activeEntity); activeEntity = null; }
      if (labelEntity) { viewer.entities.remove(labelEntity); labelEntity = null; }
      activePositions = [];
    }

    function clearAllMeasurements() {
      clearActive();
      for (const e of measureEntities) viewer.entities.remove(e);
      measureEntities.length = 0;
    }

    function setMode(newMode) {
      clearActive();
      mode = newMode;
      setStatus(mode ? ("Measure: " + mode) : "Ready");
    }

    handler.setInputAction((click) => {
      if (!mode) return;
      const pos = pickPositionFromScreen(click.position);
      if (!Cesium.defined(pos)) return;

      if (activePositions.length === 0) {
        activePositions.push(pos);
        if (mode === "distance") activeEntity = viewer.entities.add({ polyline: { positions: new Cesium.CallbackProperty(() => activePositions, false), width: 3 }});
        if (mode === "area") activeEntity = viewer.entities.add({ polygon: { hierarchy: new Cesium.CallbackProperty(() => new Cesium.PolygonHierarchy(activePositions), false), outline: true }});
        if (mode === "height") activeEntity = viewer.entities.add({ polyline: { positions: new Cesium.CallbackProperty(() => activePositions, false), width: 3 }});
        measureEntities.push(activeEntity);
        if (mode === "distance") createOrUpdateLabel("Distance: 0 m", pos);
        if (mode === "area") createOrUpdateLabel("Area: 0 m²", pos);
        if (mode === "height") createOrUpdateLabel("ΔHeight: 0 m", pos);
        return;
      }

      if (mode === "height" && activePositions.length >= 2) return;
      activePositions.push(pos);

      if (mode === "distance") {
        const d = surfaceDistanceMeters(activePositions);
        createOrUpdateLabel("Distance: " + formatMeters(d), pos);
      } else if (mode === "area") {
        const a = polygonAreaSqMeters(activePositions);
        createOrUpdateLabel("Area: " + formatArea(a), pos);
      } else if (mode === "height") {
        const c1 = carto(activePositions[0]), c2 = carto(activePositions[1]);
        const dh = Math.abs((c2.height || 0) - (c1.height || 0));
        createOrUpdateLabel("ΔHeight: " + formatMeters(dh), pos);
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction((movement) => {
      if (!mode || activePositions.length === 0 || mode === "height") return;
      const pos = pickPositionFromScreen(movement.endPosition);
      if (!Cesium.defined(pos)) return;
      const preview = activePositions.slice();
      preview.push(pos);
      if (mode === "distance") {
        const d = surfaceDistanceMeters(preview);
        createOrUpdateLabel("Distance: " + formatMeters(d), pos);
      } else if (mode === "area") {
        const a = polygonAreaSqMeters(preview);
        createOrUpdateLabel("Area: " + formatArea(a), pos);
      }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    handler.setInputAction(() => {
      if (!mode || activePositions.length < 2 || (mode === "area" && activePositions.length < 3)) return;
      mode = null;
      setStatus("Ready");
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") { clearActive(); mode = null; setStatus("Ready"); }
    });

    document.getElementById("btnMeasureDistance").addEventListener("click", () => setMode("distance"));
    document.getElementById("btnMeasureArea").addEventListener("click", () => setMode("area"));
    document.getElementById("btnMeasureHeight").addEventListener("click", () => setMode("height"));
    document.getElementById("btnClearMeasures").addEventListener("click", clearAllMeasurements);
    document.getElementById("btnClearModels").addEventListener("click", () => {
      for (const tileset of currentTilesets) viewer.scene.primitives.remove(tileset);
      currentTilesets = [];
      setStatus("All models cleared");
    });
  </script>
</body>
</html>
